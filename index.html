<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Email Incident Formatter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0d2c6c;
            text-align: center;
            margin-bottom: 25px;
        }
        .text-areas {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .box {
            flex: 1;
            min-width: 300px;
        }
        textarea {
            width: 100%;
            height: 500px;
            padding: 15px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 14px;
            font-family: "Courier New", Courier, monospace;
            box-sizing: border-box;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #1877f2;
            box-shadow: 0 0 0 2px #e7f3ff;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #606770;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #1877f2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #166fe5;
        }
        #copyButton {
            background-color: #42b72a;
            margin-left: 10px;
        }
        #copyButton:hover {
            background-color: #36a420;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Sentinel Email Incident Formatter</h1>
    <div class="text-areas">
        <div class="box">
            <label for="rawDataInput">1. Paste Raw Data Here</label>
            <textarea id="rawDataInput" placeholder="Paste the raw email data from Sentinel..."></textarea>
        </div>
        <div class="box">
            <label for="formattedOutput">2. Formatted Output</label>
            <textarea id="formattedOutput" readonly placeholder="Your formatted text will appear here..."></textarea>
        }
        </div>
    </div>
    <div class="button-container">
        <button id="formatButton">Format Incident Data</button>
        <button id="copyButton">Copy to Clipboard</button>
    </div>
</div>

<script>
    document.getElementById('formatButton').addEventListener('click', function() {
        const rawData = document.getElementById('rawDataInput').value;
        const outputArea = document.getElementById('formattedOutput');

        // --- Universal Helper Function to Extract Values ---
        const getValue = (key) => {
            // Method 1: Key on its own line, value on the next (common in both formats)
            let match = rawData.match(new RegExp(`^${key}\\s*\\n([^\\n]+)`, 'im'));
            if (match) return match[1].trim();

            // Method 2: Key and value on the same line (for new format)
            match = rawData.match(new RegExp(`^${key}\\s+([^\\n]+)`, 'im'));
            if (match) return match[1].trim();

            // Method 3: Fallback for old "jumbled line" format
            const jumbledLineMatch = rawData.match(/^(Country\/Region[A-Z]{2}Language.*)/im);
            if (jumbledLineMatch) {
                const jumbledLine = jumbledLineMatch[0];
                const keySequence = ['Country/Region', 'Language', 'Spam Confidence Level', 'Spam Filtering Verdict', 'IP Filter Verdict', 'HELO/EHLO String', 'PTR Record', 'Connecting IP Address', 'Protection Policy Category'];
                const currentIndex = keySequence.findIndex(k => key.toLowerCase() === k.toLowerCase());

                if (currentIndex !== -1) {
                    const currentKey = keySequence[currentIndex];
                    const nextKey = keySequence[currentIndex + 1];
                    const pattern = nextKey ? `${currentKey}(.*?)(?=${nextKey})` : `${currentKey}(.*)`;
                    match = jumbledLine.match(new RegExp(pattern, 'i'));
                    if (match) return match[1].trim();
                }
            }

            return 'N/A'; // Return N/A if no method works
        };

        // --- Data Extraction using the universal helper ---
        // Updated subject regex to handle both formats (with or without colon)
        const subject = rawData.match(/^Subject\s*:?\s*(.*)/im)?.[1].trim().replace(/'/g, '') || 'N/A';
        
        const recipient = getValue('Recipient\\(s\\)');
        const senderMailFrom = getValue('Sender mail from address');
        const senderAddress = getValue('Sender address');
        const senderIp = getValue('Sender IP');
        const timeReceived = getValue('Time received \\(UTC \\+05:30\\)');
        const directionality = getValue('Directionality');
        const networkMessageId = getValue('Network message ID');
        const internetMessageId = getValue('Internet message ID');
        const originalLocation = getValue('Original location');
        const deliveryAction = getValue('Delivery action');
        const latestDeliveryLocation = getValue('Latest delivery location');

        const country = getValue('Country/Region');
        const language = getValue('Language');
        const scl = getValue('Spam Confidence Level');
        const sfv = getValue('Spam Filtering Verdict');
        const ipFilter = getValue('IP Filter Verdict');
        const helo = getValue('HELO/EHLO String');
        const ptr = getValue('PTR Record');
        const connectingIp = getValue('Connecting IP Address');
        const policyCategory = getValue('Protection Policy Category');
        const bcl = getValue('Bulk Complaint Level');

        const unknownMatch = rawData.match(/Unknown fields\s*(.*);/im);
        const unknownFields = unknownMatch ? unknownMatch[1].replace(':', ': ').trim() : 'N/A';

        const authMatch = rawData.match(/^(spf=pass.*)/im);
        let authResults = 'N/A';
        if (authMatch) {
            authResults = authMatch[0].split(';').map(part => {
                const trimmedPart = part.trim();
                if (trimmedPart.startsWith('spf=') || trimmedPart.startsWith('dkim=')) {
                    const closingParenIndex = trimmedPart.indexOf(')');
                    if (closingParenIndex !== -1) return trimmedPart.substring(0, closingParenIndex + 1);
                }
                if (trimmedPart.startsWith('dmarc=')) {
                    const dmarcMatch = trimmedPart.match(/^dmarc=\w+/);
                    return dmarcMatch ? dmarcMatch[0] : trimmedPart;
                }
                return trimmedPart;
            }).join('\n');
        }

        const defang = (str) => (typeof str === 'string' ? str.replace(/\./g, '[.]') : str);
        
        let senderDomain = 'N/A';
        try {
            senderDomain = new URL('http://' + senderAddress.split('@')[1]).hostname;
        } catch (e) {
            senderDomain = senderAddress.split('@')[1] || 'N/A';
        }

        // --- Final Formatted Text (Structure remains the same) ---
        const formattedText = `Analysis:
We have observed that "${defang(recipient)}" has received a mail from "${defang(senderMailFrom)}" having subject line "${subject}"

Email Header Details:
Subject Line: ${subject}
Sender Address: ${defang(senderAddress)}
Sender Mail from Address: ${defang(senderMailFrom)}
Sender IP: ${defang(senderIp)}
Recipient(s): ${defang(recipient)}
Time Received: ${timeReceived}
Directionality: ${directionality}
Network Message ID: ${networkMessageId}
Internet Message ID: ${defang(internetMessageId)}

Delivery Details:
Original location: ${originalLocation}
Delivery action: ${deliveryAction}
Latest delivery location: ${latestDeliveryLocation}

Authentication-Results:
${defang(authResults)}

Additional Details:
Country/Region - ${country}
Language - ${language}
Spam Confidence Level - ${scl}
Spam Filtering Verdict - ${sfv}
IP Filter Verdict - ${ipFilter}
HELO/EHLO String - ${defang(helo)}
PTR Record - ${defang(ptr)}
Connecting IP Address - ${defang(connectingIp)}
Protection Policy Category - ${policyCategory}
Unknown fields - ${unknownFields}
Bulk Complaint Level: ${bcl}

Reputation of Sender IP â€“ ${defang(senderIp)}
ISP: [Please check and fill] | Location: [Please check and fill]
IPVoid : [Please check and fill]
VirusTotal : [Please check and fill]
AbuseIPDB: [Please check and fill]

Reputation of Domain - ${defang(senderDomain)} - [Please check registration age]
Virustotal: [Please check and fill]
UrlVoid : [Please check and fill]
Symantec category: [Please check and fill]

URLs Observed:
[Please list URLs here]

Attachments Observed:
[Please list attachments here, or state "No attachments."]

Observation:
[Please add your final observation here.]
`;
        outputArea.value = formattedText;
    });

    document.getElementById('copyButton').addEventListener('click', function() {
        const outputArea = document.getElementById('formattedOutput');
        outputArea.select();
        outputArea.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(outputArea.value).then(() => {
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => { this.textContent = originalText; }, 1500);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Failed to copy text.');
        });
    });
</script>

</body>
</html>
