<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Email Incident Formatter</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #1c1e21;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #0d2c6c;
            text-align: center;
            margin-bottom: 25px;
        }
        .text-areas {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .box {
            flex: 1;
            min-width: 300px;
        }
        textarea {
            width: 100%;
            height: 500px;
            padding: 15px;
            border: 1px solid #dddfe2;
            border-radius: 6px;
            font-size: 14px;
            font-family: "Courier New", Courier, monospace;
            box-sizing: border-box;
            resize: vertical;
        }
        textarea:focus {
            outline: none;
            border-color: #1877f2;
            box-shadow: 0 0 0 2px #e7f3ff;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #606770;
        }
        .button-container {
            text-align: center;
            margin-top: 20px;
        }
        button {
            background-color: #1877f2;
            color: #fff;
            border: none;
            border-radius: 6px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #166fe5;
        }
        #copyButton {
            background-color: #42b72a;
            margin-left: 10px;
        }
        #copyButton:hover {
            background-color: #36a420;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Sentinel Email Incident Formatter</h1>
    <div class="text-areas">
        <div class="box">
            <label for="rawDataInput">1. Paste Raw Data Here</label>
            <textarea id="rawDataInput" placeholder="Paste the raw email data from Sentinel..."></textarea>
        </div>
        <div class="box">
            <label for="formattedOutput">2. Formatted Output</label>
            <textarea id="formattedOutput" readonly placeholder="Your formatted text will appear here..."></textarea>
        }
        </div>
    </div>
    <div class="button-container">
        <button id="formatButton">Format Incident Data</button>
        <button id="copyButton">Copy to Clipboard</button>
    </div>
</div>

<script>
    document.getElementById('formatButton').addEventListener('click', function() {
        const rawData = document.getElementById('rawDataInput').value;
        const outputArea = document.getElementById('formattedOutput');

        const getValue = (key) => {
            let match = rawData.match(new RegExp(`^${key}\\s*\\n([^\\n]+)`, 'im'));
            if (match) return match[1].trim();
            match = rawData.match(new RegExp(`^${key}\\s+([^\\n]+)`, 'im'));
            if (match) return match[1].trim();
            return 'N/A';
        };

        // --- Advanced Subject & Attachment/Link Parsing ---
        let subject = 'N/A';
        let attachmentCount = '[Please check and fill]';
        let linkCount = '[Please check and fill]';

        const emailHeaderMatch = rawData.match(/^(Email|email)\s*\d*\s*\n([\s\S]*?)(?=Delivery details)/im);
        if (emailHeaderMatch) {
            const content = emailHeaderMatch[2].trim().split('\n');
            subject = content[0].trim();
            if (content.length > 1) {
                const countLineMatch = content[1].match(/(\d+)\s*Attachments\s*(\d+)\s*Links/i);
                if (countLineMatch) {
                    attachmentCount = countLineMatch[1] || '0';
                    linkCount = countLineMatch[2] || '0';
                }
            }
        } else {
             const subjectMatch = rawData.match(/^Subject\s*:?\s*([\s\S]*?)(?=Delivery details)/im);
             subject = subjectMatch ? subjectMatch[1].trim().replace(/\n/g, ' ') : 'N/A';
        }

        // --- Data Extraction ---
        const replyTo = getValue('Return path'); // Automatically extract Reply To field
        const recipient = getValue('Recipient\\(s\\)');
        const senderMailFrom = getValue('Sender mail from address');
        const senderAddress = getValue('Sender address');
        const senderIp = getValue('Sender IP');
        const timeReceived = getValue('Time received \\(UTC \\+05:30\\)');
        const directionality = getValue('Directionality');
        const networkMessageId = getValue('Network message ID');
        const internetMessageId = getValue('Internet message ID');
        const originalLocation = getValue('Original location');
        const deliveryAction = getValue('Delivery action');
        const latestDeliveryLocation = getValue('Latest delivery location');

        const country = getValue('Country/Region');
        const language = getValue('Language');
        const scl = getValue('Spam Confidence Level');
        const sfv = getValue('Spam Filtering Verdict');
        const ipFilter = getValue('IP Filter Verdict');
        const helo = getValue('HELO/EHLO String');
        const ptr = getValue('PTR Record');
        const connectingIp = getValue('Connecting IP Address');
        const policyCategory = getValue('Protection Policy Category');
        const bcl = getValue('Bulk Complaint Level');
        
        const unknownFields = rawData.match(/Unknown fields\s*(.*);/im)?.[1].replace(':', ': ').trim() || 'N/A';

        const authLines = rawData.match(/^(.*\b(spf|dkim|dmarc)=.*)/img);
        let authResults = 'N/A';
        if (authLines) {
            authResults = authLines.map(line => {
                return line.split(';').map(part => {
                    const trimmed = part.trim();
                    if (trimmed.startsWith('spf=') || trimmed.startsWith('dkim=')) {
                        const match = trimmed.match(/^.*?\)/);
                        return match ? match[0] : trimmed;
                    }
                    if (trimmed.startsWith('dmarc=')) {
                        return trimmed.split(' ')[0];
                    }
                    return trimmed;
                }).join('\n');
            }).join('\n');
        }

        const defang = (str) => (typeof str === 'string' ? str.replace(/\./g, '[.]') : str);
        
        let senderDomain = 'N/A';
        if (senderAddress !== 'N/A' && senderAddress.includes('@')) {
            senderDomain = senderAddress.split('@')[1];
        }

        const formattedText = `Analysis:
We have observed that "${defang(recipient)}" has received a mail from "${defang(senderMailFrom)}" having subject line "${subject}"

Email Header Details:
Subject Line: ${subject}
Sender Address: ${defang(senderAddress)}
Sender Mail from Address: ${defang(senderMailFrom)}
Reply To: ${defang(replyTo)}
Sender IP: ${defang(senderIp)}
Recipient(s): ${defang(recipient)}
Time Received: ${timeReceived}
Directionality: ${directionality}
Network Message ID: ${networkMessageId}
Internet Message ID: ${defang(internetMessageId)}

Delivery Details:
Original location: ${originalLocation}
Delivery action: ${deliveryAction}
Latest delivery location: ${latestDeliveryLocation}

Authentication-Results:
${defang(authResults)}

Additional Details:
Country/Region - ${country}
Language - ${language}
Spam Confidence Level - ${scl}
Spam Filtering Verdict - ${sfv}
IP Filter Verdict - ${ipFilter}
HELO/EHLO String - ${defang(helo)}
PTR Record - ${defang(ptr)}
Connecting IP Address - ${defang(connectingIp)}
Protection Policy Category - ${policyCategory}
Unknown fields - ${unknownFields}
Bulk Complaint Level: ${bcl}

Reputation of Sender IP â€“ ${defang(senderIp)}
ISP: [Please check and fill] | Location: [Please check and fill]
IPVoid : [Please check and fill]
VirusTotal : [Please check and fill]
AbuseIPDB: [Please check and fill]

Reputation of Domain - ${defang(senderDomain)} - [Please check registration age]
Virustotal: [Please check and fill]
UrlVoid : [Please check and fill]
Symantec category: [Please check and fill]

URLs Observed:
Total URL's: ${linkCount}
Url Details: [Please paste URL details here]

Attachments Observed:
Total Attachments: ${attachmentCount}
Attachment Details: [Please paste attachment details here]

Observation:
[Please add your final observation here.]
`;
        outputArea.value = formattedText;
    });

    document.getElementById('copyButton').addEventListener('click', function() {
        const outputArea = document.getElementById('formattedOutput');
        outputArea.select();
        outputArea.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(outputArea.value).then(() => {
            const originalText = this.textContent;
            this.textContent = 'Copied!';
            setTimeout(() => { this.textContent = originalText; }, 1500);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Failed to copy text.');
        });
    });
</script>

</body>
</html>
